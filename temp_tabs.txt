
    
    # ==== TAB 5: VALIDA√á√ÉO V7 ====
    with tab5:
        st.markdown("### üìã Valida√ß√£o V7", unsafe_allow_html=True)
        st.markdown("Visualiza√ß√£o dos erros identificados na configura√ß√£o V7 das UTPs.")
        st.markdown("---")
        
        # Load validation report
        validation_path = Path(__file__).parent.parent.parent / "data" / "03_validation" / "v7_validation_report.xlsx"
        
        if validation_path.exists():
            try:
                # Load error summaries
                rm_errors = pd.read_excel(validation_path, sheet_name='Erros_RM_Resumo')
                rm_details = pd.read_excel(validation_path, sheet_name='Erros_RM_Detalhado')
                contig_errors = pd.read_excel(validation_path, sheet_name='Erros_Contig_Resumo')
                contig_details = pd.read_excel(validation_path, sheet_name='Erros_Contig_Detalhado')
                
                # Metrics
                col1, col2, col3 = st.columns(3)
                with col1:
                    st.metric("UTPs com Erros de RM", len(rm_errors))
                with col2:
                    st.metric("UTPs N√£o-Cont√≠guas", len(contig_errors))
                with col3:
                    total_errors = len(rm_errors) + len(contig_errors)
                    st.metric("Total de UTPs com Erros", total_errors)
                
                st.markdown("---")
                
                # Tabs for different error types
                error_tab1, error_tab2 = st.tabs(["Erros de RM", "Erros de Contiguidade"])
                
                with error_tab1:
                    st.markdown("#### Erros de Regi√£o Metropolitana")
                    st.caption("UTPs que violam regras de integridade de RM")
                    
                    if not rm_errors.empty:
                        # Show summary
                        st.dataframe(rm_errors, use_container_width=True, hide_index=True)
                        
                        st.markdown("---")
                        st.markdown("##### Detalhamento por Munic√≠pio")
                        
                        if not rm_details.empty:
                            # Filter by UTP
                            utp_options = sorted(rm_details['UTP'].unique().tolist())
                            selected_utp = st.selectbox("Filtrar por UTP", ["Todas"] + utp_options, key="rm_utp_filter")
                            
                            if selected_utp != "Todas":
                                rm_details_filtered = rm_details[rm_details['UTP'] == selected_utp]
                            else:
                                rm_details_filtered = rm_details
                            
                            st.dataframe(rm_details_filtered, use_container_width=True, hide_index=True, height=400)
                            
                            # Map visualization
                            st.markdown("---")
                            st.markdown("#### Mapa de UTPs com Erros de RM")
                            
                            if gdf is not None:
                                # Get municipalities with RM errors
                                error_munis = rm_details['Munic√≠pio_C√≥digo'].unique().tolist()
                                error_munis_str = [str(m) for m in error_munis]
                                
                                gdf_errors = gdf[gdf['CD_MUN'].astype(str).isin(error_munis_str)].copy()
                                
                                if not gdf_errors.empty:
                                    # Color by error type
                                    error_type_map = rm_details.set_index('Munic√≠pio_C√≥digo')['Error_Type'].to_dict()
                                    
                                    def get_error_color(row):
                                        try:
                                            mun_code = int(row['CD_MUN'])
                                            error_type = error_type_map.get(mun_code, 'Unknown')
                                            if 'M√∫ltiplas RMs' in error_type:
                                                return '#FF4444'  # Red for multiple RMs
                                            elif 'Mix' in error_type:
                                                return '#FFA500'  # Orange for mix
                                            else:
                                                return '#FFFF00'  # Yellow for other
                                        except:
                                            return '#CCCCCC'
                                    
                                    gdf_errors['color'] = gdf_errors.apply(get_error_color, axis=1)
                                    
                                    # Create map
                                    m_rm_errors = folium.Map(
                                        location=[-15, -55],
                                        zoom_start=4,
                                        tiles="CartoDB positron",
                                        prefer_canvas=True
                                    )
                                    
                                    bounds = gdf_errors.total_bounds
                                    m_rm_errors.fit_bounds([[bounds[1], bounds[0]], [bounds[3], bounds[2]]], padding=(0.05, 0.05))
                                    
                                    folium.GeoJson(
                                        gdf_errors.to_json(),
                                        style_function=lambda x: {
                                            'fillColor': x['properties'].get('color', '#cccccc'),
                                            'color': '#000000',
                                            'weight': 1.5,
                                            'fillOpacity': 0.7
                                        },
                                        tooltip=folium.GeoJsonTooltip(
                                            fields=['NM_MUN', 'utp_id', 'regiao_metropolitana'],
                                            aliases=['Munic√≠pio:', 'UTP:', 'RM:'],
                                            localize=True
                                        )
                                    ).add_to(m_rm_errors)
                                    
                                    # Legend
                                    legend_html = '''
                                    <div style="position: fixed; bottom: 50px; right: 50px; z-index:9999; 
                                                background-color: white; padding: 10px; border: 2px solid grey; border-radius: 5px;">
                                    <p style="margin:0; font-weight:bold;">Tipo de Erro:</p>
                                    <p style="margin:0;"><span style="color:#FF4444;">‚óè</span> M√∫ltiplas RMs</p>
                                    <p style="margin:0;"><span style="color:#FFA500;">‚óè</span> Mix RM/N√£o-RM</p>
                                    </div>
                                    '''
                                    m_rm_errors.get_root().html.add_child(folium.Element(legend_html))
                                    
                                    st.components.v1.html(m_rm_errors._repr_html_(), height=500)
                                else:
                                    st.info("Nenhum munic√≠pio com erro de RM encontrado no mapa")
                        else:
                            st.info("Nenhum detalhe de munic√≠pio dispon√≠vel")
                    else:
                        st.success("‚úÖ Nenhum erro de RM encontrado na V7!")
                
                with error_tab2:
                    st.markdown("#### Erros de Contiguidade")
                    st.caption("UTPs com munic√≠pios geograficamente desconectados")
                    
                    if not contig_errors.empty:
                        # Show summary
                        st.dataframe(contig_errors, use_container_width=True, hide_index=True)
                        
                        st.markdown("---")
                        st.markdown("##### Detalhamento por Munic√≠pio")
                        
                        if not contig_details.empty:
                            # Filter by UTP
                            utp_options_contig = sorted(contig_details['UTP'].unique().tolist())
                            selected_utp_contig = st.selectbox("Filtrar por UTP", ["Todas"] + utp_options_contig, key="contig_utp_filter")
                            
                            if selected_utp_contig != "Todas":
                                contig_details_filtered = contig_details[contig_details['UTP'] == selected_utp_contig]
                            else:
                                contig_details_filtered = contig_details
                            
                            st.dataframe(contig_details_filtered, use_container_width=True, hide_index=True, height=400)
                            
                            # Map visualization
                            st.markdown("---")
                            st.markdown("#### Mapa de UTPs N√£o-Cont√≠guas")
                            
                            if gdf is not None:
                                # Get municipalities with contiguity errors
                                error_munis_contig = contig_details['Munic√≠pio_C√≥digo'].unique().tolist()
                                error_munis_contig_str = [str(m) for m in error_munis_contig]
                                
                                gdf_errors_contig = gdf[gdf['CD_MUN'].astype(str).isin(error_munis_contig_str)].copy()
                                
                                if not gdf_errors_contig.empty:
                                    # Color by component
                                    component_map = contig_details.set_index('Munic√≠pio_C√≥digo')['Componente_N√∫mero'].to_dict()
                                    
                                    def get_component_color(row):
                                        try:
                                            mun_code = int(row['CD_MUN'])
                                            component = component_map.get(mun_code, 'Componente 1')
                                            if 'Componente 1' in component:
                                                return '#4CAF50'  # Green for main component
                                            elif 'Componente 2' in component:
                                                return '#FF9800'  # Orange for secondary
                                            elif 'Componente 3' in component:
                                                return '#9C27B0'  # Purple for tertiary
                                            else:
                                                return '#F44336'  # Red for others
                                        except:
                                            return '#CCCCCC'
                                    
                                    gdf_errors_contig['color'] = gdf_errors_contig.apply(get_component_color, axis=1)
                                    
                                    # Create map
                                    m_contig_errors = folium.Map(
                                        location=[-15, -55],
                                        zoom_start=4,
                                        tiles="CartoDB positron",
                                        prefer_canvas=True
                                    )
                                    
                                    bounds = gdf_errors_contig.total_bounds
                                    m_contig_errors.fit_bounds([[bounds[1], bounds[0]], [bounds[3], bounds[2]]], padding=(0.05, 0.05))
                                    
                                    folium.GeoJson(
                                        gdf_errors_contig.to_json(),
                                        style_function=lambda x: {
                                            'fillColor': x['properties'].get('color', '#cccccc'),
                                            'color': '#000000',
                                            'weight': 1.5,
                                            'fillOpacity': 0.7
                                        },
                                        tooltip=folium.GeoJsonTooltip(
                                            fields=['NM_MUN', 'utp_id'],
                                            aliases=['Munic√≠pio:', 'UTP:'],
                                            localize=True
                                        )
                                    ).add_to(m_contig_errors)
                                    
                                    # Legend
                                    legend_html_contig = '''
                                    <div style="position: fixed; bottom: 50px; right: 50px; z-index:9999; 
                                                background-color: white; padding: 10px; border: 2px solid grey; border-radius: 5px;">
                                    <p style="margin:0; font-weight:bold;">Componente:</p>
                                    <p style="margin:0;"><span style="color:#4CAF50;">‚óè</span> Principal (maior)</p>
                                    <p style="margin:0;"><span style="color:#FF9800;">‚óè</span> Secund√°rio</p>
                                    <p style="margin:0;"><span style="color:#9C27B0;">‚óè</span> Terci√°rio</p>
                                    <p style="margin:0;"><span style="color:#F44336;">‚óè</span> Outros</p>
                                    </div>
                                    '''
                                    m_contig_errors.get_root().html.add_child(folium.Element(legend_html_contig))
                                    
                                    st.components.v1.html(m_contig_errors._repr_html_(), height=500)
                                else:
                                    st.info("Nenhum munic√≠pio com erro de contiguidade encontrado no mapa")
                        else:
                            st.info("Nenhum detalhe de munic√≠pio dispon√≠vel")
                    else:
                        st.success("‚úÖ Nenhum erro de contiguidade encontrado na V7!")
                
            except Exception as e:
                st.error(f"Erro ao carregar relat√≥rio de valida√ß√£o: {e}")
                st.info("Execute o script de valida√ß√£o primeiro: `python scripts/validate_v7.py`")
        else:
            st.warning("Relat√≥rio de valida√ß√£o V7 n√£o encontrado")
            st.info(f"Execute o script de valida√ß√£o primeiro:\n\n`python scripts/validate_v7.py`")
            st.caption(f"Arquivo esperado: {validation_path}")
    
    
    # ==== TAB 6: CONSOLIDA√á√ïES V8‚ÜíV9 ====
    with tab6:
        st.markdown("### üîÄ Consolida√ß√µes V8‚ÜíV9", unsafe_allow_html=True)
        st.markdown("An√°lise detalhada das consolida√ß√µes de UTPs unit√°rias realizadas no pipeline.")
        st.markdown("---")
        
        # Load consolidation analysis report
        consolidation_analysis_path = Path(__file__).parent.parent.parent / "data" / "03_validation" / "v8_v9_consolidation_analysis.xlsx"
        
        if consolidation_analysis_path.exists():
            try:
                # Load sheets
                summary = pd.read_excel(consolidation_analysis_path, sheet_name='Resumo')
                all_consolidations = pd.read_excel(consolidation_analysis_path, sheet_name='Todas_Consolida√ß√µes')
                unitary_consolidated = pd.read_excel(consolidation_analysis_path, sheet_name='Unit√°rias_Consolidadas')
                by_reason = pd.read_excel(consolidation_analysis_path, sheet_name='Por_Motivo')
                
                # Display summary metrics
                st.markdown("#### Resumo Geral")
                
                # Create columns for metrics
                cols = st.columns(4)
               
                # Extract key metrics from summary
                for idx, row in summary.iterrows():
                    metric_name = row['M√©trica']
                    metric_value = row['Valor']
                    
                    if idx < 4:  # Show first 4 metrics
                        with cols[idx]:
                            st.metric(metric_name, metric_value)
                
                st.markdown("---")
                
                #Tabs for different views
                cons_tab1, cons_tab2, cons_tab3 = st.tabs(["Todas Consolida√ß√µes", "UTPs Unit√°rias", "Por Motivo"])
                
                with cons_tab1:
                    st.markdown("#### Todas as Consolida√ß√µes")
                    st.caption(f"{len(all_consolidations)} consolida√ß√µes realizadas")
                    
                    # Filter options
                    col_filter1, col_filter2 = st.columns(2)
                    with col_filter1:
                        reason_options = ["Todas"] + sorted(all_consolidations['Motivo_Consolida√ß√£o'].unique().tolist())
                        selected_reason = st.selectbox("Filtrar por Motivo", reason_options, key="all_cons_reason")
                    
                    with col_filter2:
                        unitary_filter = st.selectbox("Era Unit√°ria?", ["Todas", "Sim", "N√£o"], key="all_cons_unitary")
                    
                    # Apply filters
                    df_filtered_cons = all_consolidations.copy()
                    if selected_reason != "Todas":
                        df_filtered_cons = df_filtered_cons[df_filtered_cons['Motivo_Consolida√ß√£o'] == selected_reason]
                    if unitary_filter != "Todas":
                        df_filtered_cons = df_filtered_cons[df_filtered_cons['Era_Unit√°ria'] == unitary_filter]
                    
                    st.dataframe(df_filtered_cons, use_container_width=True, hide_index=True, height=500)
                    
                    # Download option
                    csv = df_filtered_cons.to_csv(index=False).encode('utf-8')
                    st.download_button(
                        label="üì• Baixar CSV",
                        data=csv,
                        file_name="consolidacoes_filtradas.csv",
                        mime="text/csv"
                    )
                
                with cons_tab2:
                    st.markdown("#### UTPs Unit√°rias Consolidadas")
                    st.caption(f"{len(unitary_consolidated)} UTPs unit√°rias foram consolidadas")
                    
                    if not unitary_consolidated.empty:
                        # Show data
                        st.dataframe(unitary_consolidated, use_container_width=True, hide_index=True, height=500)
                        
                        # Map visualization
                        st.markdown("---")
                        st.markdown("#### Mapa de Consolida√ß√µes de Unit√°rias")
                        
                        if gdf is not None:
                            # Get municipalities from unitary consolidations
                            unitary_munis = unitary_consolidated['Munic√≠pio_C√≥digo'].unique().tolist()
                            unitary_munis_str = [str(m) for m in unitary_munis]
                            
                            gdf_unitary = gdf[gdf['CD_MUN'].astype(str).isin(unitary_munis_str)].copy()
                            
                            if not gdf_unitary.empty:
                                # Color by consolidation reason
                                reason_map = unitary_consolidated.set_index('Munic√≠pio_C√≥digo')['Motivo'].to_dict()
                                
                                def get_reason_color(row):
                                    try:
                                        mun_code = int(row['CD_MUN'])
                                        reason = reason_map.get(mun_code, 'Unknown')
                                        if 'Com RM' in reason:
                                            return '#2196F3'  # Blue for RM + Flow
                                        elif 'Sem RM' in reason:
                                            return '#4CAF50'  # Green for Flow only
                                        elif 'REGIC' in reason:
                                            return '#FF9800'  # Orange for REGIC
                                        else:
                                            return '#9E9E9E'  # Gray for unknown
                                    except:
                                        return '#CCCCCC'
                                
                                gdf_unitary['color'] = gdf_unitary.apply(get_reason_color, axis=1)
                                
                                # Create map
                                m_unitary = folium.Map(
                                    location=[-15, -55],
                                    zoom_start=4,
                                    tiles="CartoDB positron",
                                    prefer_canvas=True
                                )
                                
                                bounds = gdf_unitary.total_bounds
                                m_unitary.fit_bounds([[bounds[1], bounds[0]], [bounds[3], bounds[2]]], padding=(0.05, 0.05))
                                
                                folium.GeoJson(
                                    gdf_unitary.to_json(),
                                    style_function=lambda x: {
                                        'fillColor': x['properties'].get('color', '#cccccc'),
                                        'color': '#000000',
                                        'weight': 2.0,
                                        'fillOpacity': 0.8
                                    },
                                    tooltip=folium.GeoJsonTooltip(
                                        fields=['NM_MUN', 'utp_id', 'regiao_metropolitana'],
                                        aliases=['Munic√≠pio:', 'UTP Original:', 'RM:'],
                                        localize=True
                                    )
                                ).add_to(m_unitary)
                                
                                # Legend
                                legend_html_unitary = '''
                                <div style="position: fixed; bottom: 50px; right: 50px; z-index:9999; 
                                            background-color: white; padding: 10px; border: 2px solid grey; border-radius: 5px;">
                                <p style="margin:0; font-weight:bold;">Motivo:</p>
                                <p style="margin:0;"><span style="color:#2196F3;">‚óè</span> Com RM - Fluxo</p>
                                <p style="margin:0;"><span style="color:#4CAF50;">‚óè</span> Sem RM - Fluxo</p>
                                <p style="margin:0;"><span style="color:#FF9800;">‚óè</span> REGIC</p>
                                </div>
                                '''
                                m_unitary.get_root().html.add_child(folium.Element(legend_html_unitary))
                                
                                st.components.v1.html(m_unitary._repr_html_(), height=500)
                            else:
                                st.info("Nenhum munic√≠pio unit√°rio consolidado encontrado no mapa")
                    else:
                        st.info("Nenhuma UTP unit√°ria foi consolidada")
                
                with cons_tab3:
                    st.markdown("#### Consolida√ß√µes por Motivo")
                    
                    if not by_reason.empty:
                        # Display table
                        st.dataframe(by_reason, use_container_width=True, hide_index=True)
                        
                        # Chart
                        st.markdown("---")
                        st.markdown("#### Distribui√ß√£o por Motivo")
                        
                        import plotly.express as px
                        
                        fig = px.bar(
                            by_reason,
                            x='Motivo',
                            y='Quantidade',
                            title='N√∫mero de Consolida√ß√µes por Motivo',
                            labels={'Quantidade': 'N√∫mero de Consolida√ß√µes', 'Motivo': 'Motivo da Consolida√ß√£o'},
                            color='Quantidade',
                            color_continuous_scale='Blues'
                        )
                        
                        fig.update_layout(showlegend=False, height=400)
                        st.plotly_chart(fig, use_container_width=True)
                        
                        # Flow average
                        st.markdown("---")
                        st.markdown("#### Fluxo M√©dio por Motivo")
                        
                        fig2 = px.bar(
                            by_reason,
                            x='Motivo',
                            y='Fluxo_M√©dio',
                            title='Fluxo M√©dio de Viagens por Motivo de Consolida√ß√£o',
                            labels={'Fluxo_M√©dio': 'Fluxo M√©dio (viagens)', 'Motivo': 'Motivo da Consolida√ß√£o'},
                            color='Fluxo_M√©dio',
                            color_continuous_scale='Greens'
                        )
                        
                        fig2.update_layout(showlegend=False, height=400)
                        st.plotly_chart(fig2, use_container_width=True)
                    else:
                        st.info("Nenhum dado dispon√≠vel")
                
            except Exception as e:
                st.error(f"Erro ao carregar relat√≥rio de consolida√ß√µes: {e}")
                import traceback
                st.code(traceback.format_exc())
                st.info("Execute o script de an√°lise primeiro: `python scripts/analyze_v8_v9_consolidations.py`")
        else:
            st.warning("Relat√≥rio de consolida√ß√µes n√£o encontrado")
            st.info(f"Execute o script de an√°lise primeiro:\n\n`python scripts/analyze_v8_v9_consolidations.py`")
            st.caption(f"Arquivo esperado: {consolidation_analysis_path}")
